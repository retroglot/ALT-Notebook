# 目标
给一套“端到端、可批量、可保留 Markdown 格式和脚注、尽量稳定输出”的 Markdown 文档翻译流程，同时保证术语与译名的一致性。

# 一条可靠的开源方案：mps-ytranslate（推荐先试）
- 仓库：https://github.com/vgoloviznin/mps-ytranslate
- 特点：
  - 专注 Markdown 文本翻译，原文与译文混排原样保留（加粗、斜体、脚注、图片、代码块等不拆分）。
  - 可选择 Google Translate、DeepL、LibreTranslate 等后端；也可配自己的 LLM 接口。
  - 支持连体段落（保留换行策略）和术语/正则映射，相当于轻度术语对齐。
  - 开源免费、自己本地/自建 API 即可用。

工作流示例：
1) 用 MinerU 将 PDF 转成 Markdown。
2) 用磁贴块或 HTML 锚点方式插入脚注为 Markdown 格式（见下一节的脚注“提前改造”方法），确保连贯。
3) 按章节切分为相对较小、格式完整的 Markdown 文件。
4) 一次性在 mps-ytranslate 里映射术语表（见后文“术语一致”）。
5) 批量运行：输入是整份 Markdown（含脚注），输出是完整译文 Markdown；再在 Obsidian 做轻度校对即可。

风险与对策：
- 长文产出若需保证“完全不丢格式”，建议每次处理章节级（典型 1–3 万字符），而不是百万字的单文件。
- 图注/表格标题在切分时要保证上下文，以防漏译或错位。

# 如果你离不开“LLM 大模型翻译”的效果与语言风格
推荐思路：先“占位替换”—让模型专注于内容—再复原格式
- 按章节/小节拆分 Markdown，保留圆括号中的数字脚注“混入正文”这一步先不改为 [^1]（否则内容会被拆分）。
- 翻译时对“脚注号”做占位替换（例如 [REF:0001]），让 LLM 保整段译文；脚注正文同理处理成占位符。
- 译完后分两轮替换：
  1) 把脚注正文复原为标准 Markdown 脚注格式（跳号、要不重号可写脚本校正）。
  2) 把译文中出现的“让/吉恩/简”等不统一人名，用术语表全局替换；或按人名列表依次全替换。

批次大小建议：
- 每批 2–4 万字符（带原始格式），这样既减少注意力漂移，又可尽量保留多段上下文。
- 以节标题或小节为自然分界。

# 术语一致：让“Jean”不变成“让”或变体
- 简短术语表（JSON/YAML），示例：
  - Jean
  - Amelie
  - Victor Hugo
  - Marie Curie
  - ...
- 应用策略（任选其一或兼用）：
  1) 在正文翻译前先用占位映射，粒度到整词：
     - 将 Jean → ##NAME01##，译完后再还原为 Jean。
     - 复杂姓名可加空白分身法：Jean Paul Sartre → ##NAME02a## ##NAME02b## Sartre，避免中间名被拆错。
  2) 正则统一处理译后文本，玛丽·居里/玛丽居里/居里夫人等全规整为“Marie Curie”（或你的统一译名）。
  3) 若配合小样式包装：（@Jean）或人名高亮，便于全文统一替换。
  4) 若你用 OmegaT/Xbench 之类 CAT，可提前导入 TMX/术语表做“从句子粒度的一致化”，但跨文档、成本较高。

# 脚注预先改造为“内联/合并”以避免被拆分
- 用 MinerU/OCR 如果识别成“（1）”离散式脚注，建议先改写为Mendeley注脚风格或“脚注正文混排”：
  - Mendeley 风格（Zotero/MyBibTeX 适用）：
    ```
    <cite key="ref1"/>正文内容。下文同一文献再用该 key。
    ```
  - 合并脚注（适合长文）：
    - 正文以圆括号脚注号“（1）”、“（2）”出现；文末集中列出脚注列表。
  - 直接改标准的 Markdown 脚注格式：
    - 正文放 [^1]，文末 [^1]: 脚注内容。若 MinerU 或 LLM 容易把它当成普通数字，可改用标题法：
      ```
      > [^1]: 这里写脚注内容

      正文文本
      ```
      或在行内加小改造，如 `#^1` 或 `<sup>[^1]</sup>`，并统一在文末批量复原。

- 目的：让“脚注正文”和正文不会在翻译时被分散到不同 chunk 中，从而大幅减少错位、回显不全的问题。

# Markdown 切分、合并与简单脚本工具
- 切分与合并（本地方便且可自定规则）：
  - markdown-toc：按标题生成章节目录并分段处理。
  - gemini-assistant：一键切分/合并 Markdown 文件。
  - outrunfish/markdown-tools：一套小工具，含切分/合并/转换。
- 轻量 API/桌面客户端：
  - Markdown-Localizer：支持 Google/NLLB（可自搭建），带占位替换设计。
  - GitHub - bjorngo/markdown-translator：把 Markdown 送给 Google 翻译。
  - docx2md/markdown-to-asciidoc：针对格式损失的参考。
- 推荐先把长文切成“标题==章节”，翻译后再“自动合并”，这样可兼顾批量效率与一致性。

# 完整流程（给你一个可走的）
1) MinerU: PDF → Markdown
2) 脚注改造：
   - 若用标准 [^...]，保持；若 MinerU 识别成普通数字，先集中到文末或用 Mendeley 风格改。
3) 命名/术语统一：
   - 建立术语 JSON；，或先占位替换人名。
4) 批量翻译（任选其一）：
   - A. mps-ytranslate + 术语映射 + DeepL/自建镜像（推荐）。
   - B. LLM：按章节发 2–4 万字符，上下文附“翻译指引+术语表”，避免章节间上下文丢失。
5) 语块批量替换：
   - 从 ADD（如：##NAME1##）复原为人名、统一译名；脚注号规整；偶发行内引文替换回来。
6) 合并为长 Markdown；微调。
7) 成稿上传到微信公众平台。

# 关于“长文注意力漂移”的常用对策
- 输出格式不变（不以纯文本方式输出），保留标题、列表、加粗、代码块、链接原文等。
- 追加“旧译文接续”提示，最末 1–2 个小节作为“锚点上下文”，减少跨小节风格漂移。
- 每几个小节设一次“回环校对句”（例如检索关键句/公式编号），作为锚点。
- 对“脚注/表格”容易遗漏的部位，做“引用完整性检查”脚本（检查每个 [^n] 是否有对应文末定义）。

# 是否能一步到位“输入 PDF 直接输出译文”
- 直接端到端（PDF→全文译文+完整 Markdown）通常会损失脚注/格式一致性；因此两步通常更稳：先固定为稳定的 Markdown，再翻译与复原格式。
- 若你执意一步：可用 Pandoc 先完成 PDF→Markdown 的“忠实结构”，但仍建议“脚注对齐”和“占位替换”后再翻译。

# 常见坑与规避
- 表格标题与列对齐容易受损：两步先把表格翻译，再贴回 Markdown；
- 导航链接与目录锚点变更：切分时保留 H1/H2 标题结构，合并后再统一更新目录和内链；
- 异体字（让/吉恩/简）反复出现：直接用全局替换并加词边界前缀（如 (?<!\p{L})Jean(?!\p{L}) → 固定译名）。

# 你可立即上手的最小化实现
- 工具选 mps-ytranslate，做术语映射，按章节批量翻译，恢复占位后合并。
- 或：选 ChatGPT/Claude，做“章节分批 + 术语表 + 占位替换 + 两轮复原”的方法，两者皆可达成“输入—输出”稳定的一体化体验。

如果你愿意，我可以根据你的资源限值与偏好，给你做一个“按你文本风格”的可运行模板与脚注/数字替换脚本。